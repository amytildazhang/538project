---
title: "511 Project"
author: "Amy Zhang"
date: "November 24, 2015"
output: pdf_document
---
http://fivethirtyeight.com/features/how-fivethirtyeight-calculates-pollster-ratings/
http://fivethirtyeight.com/features/how-the-fivethirtyeight-senate-forecast-model-works/
1. Weighted polling average
    - Recency
    - Sample size
    - Pollster rating
2. Adjusted polling average
    - Trendline adjustment
    - House effects adjustment
    - Likely voter adjustment
3. Regression. Covariates are dropped if they are not significant at confidence threshold 90%. Covariates are:
    - adjusted polling average
    - A state’s Partisan Voting Index
    - The composition of party identification in the state’s electorate 
    - The sum of individual contributions received by each candidate as of the last F.E.C. reporting period (this variable is omitted if one or both candidates are new to the race and have yet to complete an FEC filing period)
    - Incumbency status

a 600-voter poll from a firm with an average pollster rating gets a weight of 1.00 (on the day of its release55; this weight will decline as the poll ages).
- state fundamentals estimate is considered more reliable than senate (>0.35, don't know how much)
```{r}
############################
#Read in data
############################
library(stringr)
library(ggplot2)

today = as.Date("2012/10/14")
as.numeric.factor <- function(x) {as.numeric(levels(x))[x]}

#Dataset and description of data can be found at
#https://github.com/fivethirtyeight/data/tree/master/pollster-ratings
polls = read.csv("https://raw.githubusercontent.com/fivethirtyeight/data/master/pollster-ratings/raw-polls.tsv", header=TRUE, sep="\t")
polls = polls[grep(pattern = ".*Pres.*", x=polls$race),] 
polls$polldate = as.Date(polls$polldate, format='%m/%d/%Y')
polls$electiondate = as.Date(polls$electiondate, format='%m/%d/%Y')


poll.ratings =  read.csv("https://raw.githubusercontent.com/fivethirtyeight/data/master/pollster-ratings/pollster-ratings.tsv", header=TRUE, sep="\t")
head(poll.ratings)

nat.polls2012 = read.csv("2012_poll_data.csv", header=TRUE, sep="\t")
state.polls2012 = read.csv("2012_poll_data_states.csv", header=TRUE, sep='\t')

nat.polls2012$State = "USA"
polls2012 = rbind(nat.polls2012, state.polls2012)

#format dates
dates = str_split_fixed(as.character(polls2012$Date), " - ", 2)
polls2012$StartDate = as.Date(paste("2012", dates[,1], sep="/")) 
polls2012$EndDate = as.Date(paste("2012", dates[,2], sep="/")) 
polls2012$Date = floor(rowMeans(matrix(c(polls2012$StartDate, polls2012$EndDate), ncol=2)))
polls2012$Date = as.Date(polls2012$Date, origin="1970-01-01")

#format "spread"
polls2012$Spread = as.character(polls2012$Spread)
spread = str_split_fixed(polls2012$Spread, " ", 2)
obama = which(spread[,1] == "Obama")
polls2012$Spread[obama] = as.numeric(spread[obama,2])
polls2012$Spread[-obama] = -as.numeric(spread[-obama,2])
polls2012$Spread[which(is.na(polls2012$Spread))] = 0
polls2012$Spread = as.numeric(polls2012$Spread)

#format sample
polls2012$Sample = as.character(polls2012$Sample)
sample = str_split_fixed(polls2012$Sample, " ", 2)
polls2012$Type = sample[,2]
polls2012$Sample = as.numeric(sample[,1])



head(polls2012)

head(polls)
summary(polls)



#Useful groupings within "polls"
state.polls = which(polls$location != 'US')
polls2000 = which(polls$year == 2000)
polls2004 = which(polls$year == 2004)
polls2008 = which(polls$year == 2008)
#polls2012 = which(polls$year == 2012 & polls$polldate < today & polls$type_simple == 'Pres-G')
partisan = which(polls$partisan != '') #these pollsters should be excluded later
head(state.polls)


############################
#Weighted polling average
############################
#http://fivethirtyeight.com/features/how-fivethirtyeight-calculates-pollster-ratings/#fn-31
#find pollster-induced error

polls.beforetoday = which(polls2012$EndDate < today)
polldata = polls2012[polls.beforetoday,]
polldata$Poll = factor(polldata$Poll, levels=levels(poll.ratings$Pollster))
nax = which(is.na(polldata$Poll))
polldata = polldata[-nax,] #take out polls that haven't been rated by 538


#Calculating recency
#http://fivethirtyeight.com/features/how-the-fivethirtyeight-senate-forecast-model-works/#fn-13
daysfrom = as.numeric(difftime(as.Date("2012/11/01"), today, unit='days'))
recencyrate = log(2)/(14 + 0.2*daysfrom)
timedif = as.numeric(difftime(today, polldata$Date))

polldata$recency = exp(-recencyrate * timedif)


#Weighting by poll rating
polldata$rating = NA
for (i in 1:length(poll.ratings$Polls)){
  pollster = poll.ratings$Pollster[i]
  idx = which(polldata$Poll == pollster)

    polldata$rating[idx] = poll.ratings$Predictive.Plus.Minus[i]
}

polldata$Sample[which(is.na(polldata$Sample))] = 600 #538 policy


polls$sample.error = 80 * polls$samplesize^-0.5
polls$PIE = polls$error - polls$sample.error
polls$IAE = NA 
polls$plus.min = NA
for (i in 1:length(polls$PIE)){
  race = polls$race
  others = polls[polls$race == race,]
  polls$IAE[i] = mean(others$PIE)
  polls$plus.min= polls$PIE[i] - avg
} 

#pollsters
se = sd(polls$IAE)/sqrt(length(polls$IAE)) 

#http://fivethirtyeight.com/features/pollster-ratings-v30/
#regress to mean...
#add average PIE to Pollsters (1.49)
#this is basically comparison to methodologically perfect poll


#individual polls
#effective sample size
#how many respondents would a methodologically perfect have to include for it to have an expected error of 4.46 points?
#effective sample size = 6400 * total expected error^-2

#weight is ratio w/ poll of 600 respondents by pollsters of average quality (1.49 PIE)
#the average poll has effective size 283
#then weighting is effective sample size/283


#statepollsters
#going backwards in time
#calculate cumulative effective sample size (most recent, then most recent + second most, etc)
#difference b/w CESS is the marginal and treated as actual sample size

#Weighting by sample weight
polldata$Sampleweight = sqrt(polldata$Sample/600)
#http://fivethirtyeight.com/features/polls-now-weighted-by-sample-size/


##########################
##Likely Voter adjustment
##########################

rv = which(polldata$Type == "RV")
polldata$spread[rv] = polldata$spread[rv] - 2.7
#registered voter polls tend to differ from likely voter polls by 2.7 percentage points




##########################
##Trend Line Adjustment
##########################
#Create "week" variable
#Week is defined using "today"
polldata$Week = today - 7*floor(difftime(today, polldata$Date, unit='days')/7)

polldata$week = as.numeric(floor(difftime(today, polldata$Date, unit='days')/7))

polldata$StatePollster = paste(polldata$State,polldata$Poll)


statepollsters = data.frame(StatePollsters = as.character(levels(factor(polldata$StatePollster))))

polldata$TAdjustment = NA
trend.fits = lapply(statepollsters$StatePollsters, function(x){
  data = polldata[polldata$StatePollster == x,]
  fit = NA
  if (length(data$Poll) < 10){ #apparently changing this to ifelse breaks lapply
    fit = lm(Spread ~ week, data=data)
  }
  else {
    fit = loess(Spread ~ week, data=data, span=0.85, model=TRUE, surface='direct')
  }
    predict(fit, newdata=data.frame(week = 0)) - predict(fit, newdata=data)
})

for (i in 1:length(statepollsters$StatePollsters)) {
  polldata$TAdjustment[polldata$StatePollster == statepollsters$StatePollsters[i]] = trend.fits[[i]] #apparently doing this inside lapply breaks R
}

polldata$TAdjusted = polldata$TAdjustment + polldata$Spread




s = state.abb
s[51] = "USA"
state.ids = data.frame(State = s, ID = seq(from=1, to=51))


aaarg = lapply(statepollsters$StatePollsters, function(x){
  bl = which(polldata$StatePollster == x)
  if (length(bl) == 1) {
    print(bl)
    bl
  }
})




aaarg = cbind(aaarg)

s = rep(NA, length(polldata$State))
s = state.ids[which(state.ids[,1] == polldata$State),2]

polldata$StateID = NA
for (i in 1:length(polldata$StateID)) {
  polldata$StateID[i] = state.ids[which(state.ids[,1] == polldata$State[i]),2]
}

polldata$PollID = NA
for (i in 1:length(polldata$PollID)) {
  polldata$PollID[i] = poll.ratings[which(poll.ratings[,2] == polldata$Poll[i]),1]
}


trend.adjustment = loess(Spread ~ factor(StateID)*factor(Poll) + factor(week), data=polldata, span=0.85)


plot(polldata$Spread ~ polldata$Week)



a = ggplot(polldata, aes(x=Week,y=Spread))
a + stat_smooth(formula = polldata$Spread ~ polldata$State*polldata$Poll + polldata$Week, method="loess")

#################
##House effects adjustment
#################

#remove polls with oly one poll per state 
s = state.abb
s[51] = "USA"

df = melt(polldata[c(1,8)], id=c("Poll", "State"))
df$count = 1

library(reshape2)

count.polls = dcast(polldata, Poll  ~., length)
singleton.idx = which(count.polls$. == 1) #states with polls conducted by only one pollsters
a = count.polls$Poll[singleton.idx]

a.idx = sapply(a, function(x){
  which(polldata$Poll == x)
})

housefx.fit = lm(TAdjusted ~ State*Poll, data=polldata[-a.idx,])

library(car)
vif(housefx.fit)
res = housefx.fit$residuals

crPlots(housefx.fit) 

outlierTest(housefx.fit)
outs = which(abs(res) > 4.087220 )
plot(fit$fitted.values ~ r.star)
r.star = rstudent(housefx.fit)
qqnorm(res)
qqline(res)

out.idx = which(abs(r.star) > 4.074962)

#removing outliers
housefx.fit2 = lm(TAdjusted ~ Poll + State, data=polldata[-out.idx,])
res = housefx.fit2$residuals
r.star = rstudent(housefx.fit2)
vif(housefx.fit2)

crPlots(housefx.fit2) 

outlierTest(housefx.fit2)
plot(housefx.fit2$fitted.values ~ r.star)


qqnorm(res)
qqline(res)


X = model.matrix(fit)
p = rankMatrix(X)
p = p[1]

beta = fit$coefficients[2]
se = sqrt(var(res)*solve(t(X) %*% X))
beta + 0.02617 * qt(0.975, 48)
beta - 0.02617 * qt(0.975, 48)



#################
##2012 predictions
################

#http://fivethirtyeight.com/features/how-the-fivethirtyeight-senate-forecast-model-works/#fn-13







census2000 = read.csv("census_data_2000.csv")
head(census2000)

census.demo = read.csv("census_demographics.csv")
head(census.demo) #same data, different numbers

elect.votes = read.csv("electoral_votes.csv")
head(elect.votes) #number of votes for each state

gallup.elect = read.csv("gallup_electorate.csv")
head(gallup.elect) #percent of democrats, republicans per state

obama_indiv_state = read.csv("obama_indiv_state.csv")
head(obama_indiv_state) #no idea what this is

part_voting = read.csv("partisan_voting.csv")
head(part_voting)

wsj.forecast = read.csv("wsj_forecast.csv", header=TRUE, sep="\t")
head(wsj.forecast) ##formatting is wonky


```